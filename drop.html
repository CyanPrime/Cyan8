	<!doctype html>
	<html>
		<head>
			<title>Cyan 8</title>
			<style>
			  * { margin: 0; padding: 0; box-sizing: border-box; }
			  body { font: 13px Helvetica, Arial; }
			  form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
			  form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
			  form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
			  #messages { list-style-type: none; margin: 0; padding: 0; }
			  #messages li { padding: 5px 10px; }
			  #messages li:nth-child(odd) { background: #eee; }
			</style>
			
			<script src="/socket.io/socket.io.js"></script>
			<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
						
			<script>
				if (window.File && window.FileReader && window.FileList && window.Blob) {
					// Great success! All the File APIs are supported.
				} else {
					alert('The File APIs are not fully supported in this browser.');
				}

				var customKeyMap = false;
				var curGameKeys;
				var gameName = "unknown";
				var game = new Array();

				var debug = false;
				var printCall = false;
				var errorOn0 = false;
				var error = false;


				var audio = (window.AudioContext || window.webkitAudioContext || window.mozAudioContext || window.oAudioContext || window.msAudioContext);
				var audCtx;
				var oscillator;
				var gain;
				var sndMinLen = 0;
			</script>
						
			<script src="js/chip8.js"></script>
			<script>
			$( document ).ready(function() {
				var socket = io();
				$('form').submit(function(){
					socket.emit('chat message', $('#m').val());
					$('#m').val('');
					return false;
				});
				
				socket.on('chat message', function(msg){
					$('#messages').append($('<li>').text(msg));
				});
				
				
				
				// Check for the various File API support.
				

				if(audio){
					audCtx = new audio();
					gain = audCtx.createGain();
					gain.connect(audCtx.destination);
				}

				function download(fileName, data) {
					var savElement = document.createElement("a");
					document.body.appendChild(savElement);
					savElement.style = "display: block; height: 100px; width:100px; border: 2px solid #888888;";
					var json = JSON.stringify(data);
					console.log("saved " + json);
					var blob = new Blob([json], {type: "octet/stream"});
					var url = window.URL.createObjectURL(blob);
					savElement.href = url;
					savElement.download = fileName;
					savElement.click();
					//savElement.innerHTML = '<a href="'+url+'">Download ' + filename + '</a>';
					//window.URL.revokeObjectURL(url);
					console.log("saved to " + url);
					
				}

				function loadJSON(path, success, error)
				{
					var xhr = new XMLHttpRequest();
					xhr.onreadystatechange = function()
					{
						if (xhr.readyState === XMLHttpRequest.DONE) {
							if (xhr.status === 200) {
								if (success)
									success(JSON.parse(xhr.responseText));
							} else {
								if (error)
									error(xhr);
							}
						}
					};
					xhr.open("GET", path, true);
					xhr.send();
				}
					
				function handleFileSelect(evt) {
					evt.stopPropagation();
					evt.preventDefault();

					var files = evt.dataTransfer.files; // FileList object.
					var file = files[0];

					//socket.emit('game_bin', file);
					
					gameName = file.name;
					if(gameName.indexOf(".sav") <= 0){
						loadJSON('/json/' + file.name + '.json',
								 function(data) { 
									console.log(data); 
									
									curGameKeys = new Array();
									console.log(data);
									console.log(data.oldBtns); 
									console.log(data.oldBtns.length); 
									
									for(var i = 0; i < data.newBtns.length; i++){
										console.log('curGameKeys[' + parseInt(data.newBtns[i]) + '] = ' + parseInt(data.oldBtns[i]) + ';');
										curGameKeys[parseInt(data.newBtns[i])] = parseInt(data.oldBtns[i]);
									}
									
									document.getElementById("controls").innerHTML = data.desc;
									customKeyMap = true;
								 },
								 function(xhr) { 
									customKeyMap = false;
									document.getElementById("controls").innerHTML = "No custom controls.";
									console.error(xhr); 
								 }
							);
								
							var reader = new FileReader();
							reader.onload = function(e) {
								if(debug) console.log(e.target.result.byteLength);
								game = new Uint8Array(e.target.result);
								socket.emit('game_bin', {name: gameName, payload: e.target.result });
								
								//startEmu();
							};

							reader.onerror = function(e) {
								console.log(e);
							};
							reader.readAsArrayBuffer(file);
						}
						
						else{
							var reader = new FileReader();
							
							reader.onloadend = function(e) {
								//load savestate (.sav file)
								var result = JSON.parse(this.result);
								var savChip = result;

								myChip8.opcode = savChip.opcode;
								myChip8.V = savChip.V;
								myChip8.I = savChip.I;
								myChip8.pc = savChip.pc;
								myChip8.gfx = savChip.gfx;
								myChip8.draw = true;
								myChip8.delay_timer = savChip.delay_timer;
								myChip8.sound_timer = savChip.sound_timer;
								myChip8.stack = savChip.stack;
								myChip8.sp = savChip.sp
								myChip8.draw = savChip.draw;
								myChip8.waitForKey = savChip.waitForKey;
								myChip8.currentKey = savChip.currentKey;
								myChip8.state = savChip.state;

								//load all custom vars
								for (i = 0; i < 0x200; i++) {
									myChip8.memory[i] = savChip.memory[i];
								}
								
								//change anything that isn't default for this savestate.
								for(var i = 0x200; i < savChip.memory.byteLength; ++i){
									//0x200 == 512.
									if(savChip.memory[i] != 0)
										myChip8.memory[i] = savChip.memory[i];
									
									else
										myChip8.memory[i] = game[i];
								}
							};
							
							reader.onerror = function(e) {
								console.log(e);
							};
							
							reader.readAsText(file);
						}
				}

				function handleDragOver(evt) {
					evt.stopPropagation();
					evt.preventDefault();
					evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
				}

				// Setup the dnd listeners.
				var dropZone = document.getElementById('drop_zone');
				dropZone.addEventListener('dragover', handleDragOver, false);
				dropZone.addEventListener('drop', handleFileSelect, false);
			});
			</script>
			
		</head>
		<body style="background-color: #1c1c1c; color: #555555;">
			<div id="drop_zone" style="border:3px dotted #555555; padding: 20px 5px; width: 630px; margin-bottom: 20px; text-align: center;">Drop files here</div>
			
			<div id="controls">No game loaded.</div>

	  
			<ul id="messages"></ul>
			<form action="">
				<input id="m" autocomplete="off" /><button>Send</button>
			</form>
	  </body>
	</html>